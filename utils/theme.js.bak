console.log('Grind Extension theme utilities loaded');

class ThemeManager {
    constructor() {
        this.currentTheme = 'dark';
        this.themeChangeCallbacks = [];
        this.systemThemeQuery = null;
        
        this.initThemeDetection();
    }
    
    initThemeDetection() {
        if (window.matchMedia) {
            this.systemThemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
            this.systemThemeQuery.addListener(this.handleSystemThemeChange.bind(this));
            
            this.currentTheme = this.systemThemeQuery.matches ? 'dark' : 'light';
        }
        
        this.loadThemePreference();
    }
    
    async loadThemePreference() {
        try {
            const result = await chrome.storage.sync.get(['theme']);
            if (result.theme) {
                this.currentTheme = result.theme;
            }
        } catch (error) {
            console.error('Error loading theme preference:', error);
        }
    }
    
    handleSystemThemeChange(event) {
        const systemTheme = event.matches ? 'dark' : 'light';
        
        chrome.storage.sync.get(['theme', 'autoSyncTheme'], (result) => {
            if (result.autoSyncTheme !== false) {
                this.setTheme(systemTheme, false);
            }
        });
    }
    
    async setTheme(theme, save = true) {
        if (theme !== 'dark' && theme !== 'light') {
            console.error('Invalid theme:', theme);
            return;
        }
        
        this.currentTheme = theme;
        
        this.applyThemeToDocument();
        
        if (save) {
            try {
                await chrome.storage.sync.set({ theme: theme });
            } catch (error) {
                console.error('Error saving theme:', error);
            }
        }
        
        this.notifyThemeChange(theme);
        
        console.log('Theme set to:', theme);
    }
    
    applyThemeToDocument() {
        const body = document.body;
        const html = document.documentElement;
        
        if (this.currentTheme === 'light') {
            body.classList.add('light');
            html.setAttribute('data-theme', 'light');
        } else {
            body.classList.remove('light');
            html.setAttribute('data-theme', 'dark');
        }
        
        this.updateThemeToggleButton();
    }
    
    updateThemeToggleButton() {
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            const icon = themeToggle.querySelector('.theme-icon');
            if (icon) {
                icon.textContent = this.currentTheme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
            }
        }
    }
    
    async toggleTheme() {
        const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        await this.setTheme(newTheme);
    }
    
    getCurrentTheme() {
        return this.currentTheme;
    }
    
    isDarkTheme() {
        return this.currentTheme === 'dark';
    }
    
    isLightTheme() {
        return this.currentTheme === 'light';
    }
    
    onThemeChange(callback) {
        this.themeChangeCallbacks.push(callback);
        
        return () => {
            const index = this.themeChangeCallbacks.indexOf(callback);
            if (index > -1) {
                this.themeChangeCallbacks.splice(index, 1);
            }
        };
    }
    
    notifyThemeChange(theme) {
        this.themeChangeCallbacks.forEach(callback => {
            try {
                callback(theme);
            } catch (error) {
                console.error('Error in theme change callback:', error);
            }
        });
    }
    
    getThemeVariables() {
        const variables = {
            dark: {
                '--bg-primary': '#000000',
                '--bg-secondary': '#111111',
                '--bg-tertiary': '#222222',
                '--text-primary': '#ffffff',
                '--text-secondary': '#cccccc',
                '--text-muted': '#666666',
                '--border-primary': '#ffffff',
                '--border-secondary': '#333333',
                '--shadow-primary': '#666666',
                '--shadow-secondary': '#333333',
                '--accent-primary': '#00ff00',
                '--accent-secondary': '#ff6600',
                '--accent-danger': '#ff0000',
                '--accent-warning': '#ffff00'
            },
            light: {
                '--bg-primary': '#ffffff',
                '--bg-secondary': '#f0f0f0',
                '--bg-tertiary': '#e0e0e0',
                '--text-primary': '#000000',
                '--text-secondary': '#333333',
                '--text-muted': '#666666',
                '--border-primary': '#000000',
                '--border-secondary': '#cccccc',
                '--shadow-primary': '#cccccc',
                '--shadow-secondary': '#e0e0e0',
                '--accent-primary': '#00ff00',
                '--accent-secondary': '#ff6600',
                '--accent-danger': '#ff0000',
                '--accent-warning': '#ffff00'
            }
        };
        
        return variables[this.currentTheme] || variables.dark;
    }
    
    applyThemeVariables() {
        const variables = this.getThemeVariables();
        const root = document.documentElement;
        
        Object.entries(variables).forEach(([property, value]) => {
            root.style.setProperty(property, value);
        });
    }
    
    getButtonStyles(variant = 'primary') {
        const baseStyles = {
            fontFamily: "'Press Start 2P', 'VT323', monospace",
            border: '2px solid var(--border-primary)',
            background: 'var(--bg-primary)',
            color: 'var(--text-primary)',
            cursor: 'pointer',
            transition: 'all 0.1s ease',
            boxShadow: '4px 4px 0px var(--shadow-primary)',
            textTransform: 'uppercase',
            fontSize: '10px',
            padding: '8px 12px'
        };
        
        const variants = {
            primary: {
                background: 'var(--accent-primary)',
                color: 'var(--bg-primary)',
                borderColor: 'var(--accent-primary)'
            },
            secondary: {
                background: 'var(--accent-secondary)',
                color: 'var(--bg-primary)',
                borderColor: 'var(--accent-secondary)'
            },
            danger: {
                background: 'var(--accent-danger)',
                color: 'var(--bg-primary)',
                borderColor: 'var(--accent-danger)'
            }
        };
        
        return { ...baseStyles, ...variants[variant] };
    }
    
    async initContextTheme(context) {
        await this.loadThemePreference();
        this.applyThemeToDocument();
        this.applyThemeVariables();
        
        switch (context) {
            case 'popup':
                this.initPopupTheme();
                break;
            case 'options':
                this.initOptionsTheme();
                break;
            case 'content':
                this.initContentTheme();
                break;
        }
    }
    
    initPopupTheme() {
        console.log('Popup theme initialized');
    }
    
    initOptionsTheme() {
        console.log('Options theme initialized');
    }
    
    initContentTheme() {
        console.log('Content theme initialized');
    }
}

const themeManager = new ThemeManager();

chrome.storage.onChanged.addListener((changes, namespace) => {
    if (namespace === 'sync' && changes.theme) {
        const newTheme = changes.theme.newValue;
        if (newTheme !== themeManager.getCurrentTheme()) {
            themeManager.setTheme(newTheme, false);
        }
    }
});

if (typeof window !== 'undefined') {
    window.ThemeManager = ThemeManager;
    window.themeManager = themeManager;
}
